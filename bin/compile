#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

# config
S3_BUCKET="heroku-buildpack-nodejs"
export PKG_CONFIG_PATH=/usr/lib64/pkgconfig:/opt/local/lib/pkgconfig:/usr/local/lib/pkgconfig:/usr/lib/pkgconfig

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2

function tar_download() {
  url="$1"
  location="$2"

  mkdir -p $location
  curl $url -s -o - | tar xzf - -C $location
}

#Building qrencode
echo "-----> Building qrencode"
tar_download "http://fukuchi.org/works/qrencode/qrencode-3.4.3.tar.gz" $BUILD_DIR/qr

cd $BUILD_DIR/qr/qrencode-3.4.3
sh ./configure --enable-static --disable-shared
make
cd ../..

echo "-----> Building runtime environment"
mkdir -p .profile.d
echo "export PATH=\"$PWD/qr/qrencode-3.4.3:$PWD/bin:\$PATH\"" > .profile.d/qrencode.sh
